---
import { render, type CollectionEntry } from 'astro:content';
import Base from './Base.astro';
import TagList from '../components/TagList.astro';
import Comments from '../components/Comments.astro';
import TableOfContents from '../components/TableOfContents.astro';
import Recommended from '../components/Recommended.astro';
import { formatDate } from '../utils/dates';
import { getPostUrl, getPostImage } from '../utils/posts';

interface Props {
  post: CollectionEntry<'posts'>;
}

const { post } = Astro.props;
const { title, date, updated, type, tags, source, sourceUrl, linkUrl, linkTitle, via, viaUrl } = post.data;
const { Content } = await render(post);
const postImage = getPostImage(post);
const siteUrl = Astro.site?.toString().replace(/\/$/, '') || 'https://adelzaalouk.com';
const postUrl = `${siteUrl}${getPostUrl(post)}`;
const jsonLd = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: post.data.summary || '',
  datePublished: date.toISOString(),
  ...(updated && { dateModified: updated.toISOString() }),
  ...(postImage && { image: postImage.startsWith('http') ? postImage : `${siteUrl}${postImage}` }),
  url: postUrl,
  author: {
    '@type': 'Person',
    name: 'Adel Zaalouk',
    url: 'https://adelzaalouk.com/about/',
    sameAs: ['https://www.linkedin.com/in/adelzaalouk/', 'https://thetechnomist.com/'],
  },
  publisher: {
    '@type': 'Person',
    name: 'Adel Zaalouk',
  },
  keywords: tags,
});
---

<Base title={title} description={post.data.summary} image={postImage} type={type} date={date} updated={updated} tags={tags}>
  <script type="application/ld+json" set:html={jsonLd} />
  <TableOfContents />
  <div class="post-layout">
    <div class="post-main">
      <article class="post-full" data-pagefind-body>
        <header>
          <div class="post-meta">
            <span class="post-type">{type}</span>
            <time datetime={date.toISOString()}>{formatDate(date)}</time>
            {updated && (
              <span class="post-updated">
                (updated <time datetime={updated.toISOString()}>{formatDate(updated)}</time>)
              </span>
            )}
          </div>

          {type === 'link' && linkUrl ? (
            <>
              <h1 class="blogmark-link">
                <a href={linkUrl} target="_blank" rel="noopener">{linkTitle || title}</a>
              </h1>
              {via && (
                <p class="blogmark-via">
                  via {viaUrl ? <a href={viaUrl}>{via}</a> : via}
                </p>
              )}
            </>
          ) : (
            <h1 class="page-title">{title}</h1>
          )}

          {type === 'quote' && source && (
            <p class="quote-source">
              â€” {sourceUrl ? <a href={sourceUrl}>{source}</a> : source}
            </p>
          )}
        </header>

        <div class="prose">
          <Content />
        </div>

        <TagList tags={tags} />
      </article>

      <Comments />
    </div>
    <aside class="post-sidebar">
      <Recommended />
    </aside>
  </div>
</Base>

<style>
  .post-layout {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: var(--spacing-xl);
    align-items: start;
    max-width: 1100px;
  }

  .post-main {
    min-width: 0;
  }

  .post-sidebar {
    position: sticky;
    top: var(--spacing-lg);
  }

  .post-full {
    padding: var(--spacing-lg) 0;
  }

  .post-updated {
    color: var(--text-muted);
    font-style: italic;
  }

  @media (max-width: 1024px) {
    .post-layout {
      grid-template-columns: 1fr;
    }

    .post-sidebar {
      position: static;
      margin-top: var(--spacing-xl);
    }
  }

  /* On large screens where TOC is visible, add left margin to avoid overlap */
  @media (min-width: 1400px) {
    .post-layout {
      margin-left: 280px;
      max-width: calc(100% - 280px);
    }
  }

  /* On very large screens, balance the layout with right padding */
  @media (min-width: 1700px) {
    .post-layout {
      margin-left: 280px;
      margin-right: 80px;
      max-width: 1100px;
    }
  }
</style>
