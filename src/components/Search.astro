---
---

<div class="search-container">
  <input
    type="search"
    class="search-input"
    placeholder="Search posts..."
    id="search-input"
    aria-label="Search posts"
    autocomplete="off"
  />
  <div id="search-results" class="search-results"></div>
</div>

<script is:inline>
  (async function initSearch() {
    const input = document.getElementById('search-input');
    const results = document.getElementById('search-results');
    if (!input || !results) return;

    let debounceTimer;

    // Truncate and clean excerpt - always strip HTML
    function cleanExcerpt(excerpt, maxLength = 200) {
      if (!excerpt) return '';
      // Strip all HTML tags
      const temp = document.createElement('div');
      temp.innerHTML = excerpt;
      const text = temp.textContent || temp.innerText || '';
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength).trim() + '...';
    }

    try {
      const pagefind = await import('/pagefind/pagefind.js');
      await pagefind.init();

      input.addEventListener('input', async (e) => {
        clearTimeout(debounceTimer);
        const query = e.target.value.trim();

        if (!query) {
          results.innerHTML = '';
          return;
        }

        debounceTimer = setTimeout(async () => {
          const search = await pagefind.search(query);
          const data = await Promise.all(search.results.slice(0, 10).map((r) => r.data()));

          if (data.length === 0) {
            results.innerHTML = '<p class="search-empty">No results found for "' + query + '"</p>';
          } else {
            results.innerHTML = `
              <p class="search-count">${data.length} result${data.length === 1 ? '' : 's'} for "${query}"</p>
              ${data.map((item) => `
                <a href="${item.url}" class="search-result">
                  <h3>${item.meta?.title || 'Untitled'}</h3>
                  <p>${cleanExcerpt(item.excerpt)}</p>
                </a>
              `).join('')}
            `;
          }
        }, 150);
      });

      // Focus input on page load
      input.focus();
    } catch (e) {
      results.innerHTML = '<p class="search-dev-notice">Search is available after building the site (npm run build).</p>';
    }
  })();
</script>

<style>
  .search-container {
    max-width: 700px;
    margin: 0 auto;
  }

  .search-input {
    width: 100%;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    padding: var(--spacing-md) var(--spacing-lg);
    font-size: 1.1rem;
    margin-bottom: var(--spacing-lg);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .search-input::placeholder {
    color: var(--text-muted);
  }

  .search-results {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .search-count {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: var(--spacing-sm);
  }

  .search-result {
    display: block;
    padding: var(--spacing-lg);
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    text-decoration: none;
    transition: border-color 0.15s ease;
  }

  .search-result:hover {
    border-color: var(--accent);
  }

  .search-result h3 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: var(--spacing-sm);
    color: var(--text-primary);
  }

  .search-result:hover h3 {
    color: var(--text-primary);
  }

  .search-result p {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin: 0;
    line-height: 1.5;
  }

  .search-empty {
    color: var(--text-muted);
    text-align: center;
    padding: var(--spacing-xl);
  }

  .search-dev-notice {
    color: var(--text-secondary);
    font-style: italic;
    text-align: center;
    padding: var(--spacing-lg);
  }
</style>
