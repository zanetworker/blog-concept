---
import Base from '../../layouts/Base.astro';
import PostCard from '../../components/PostCard.astro';
import RelatedTags from '../../components/RelatedTags.astro';
import { getAllPosts, getPostsByTag } from '../../utils/posts';
import { getRelatedTags, getAllTags } from '../../utils/tags';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  const tags = getAllTags(posts);

  return [...tags.keys()].map(tag => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
const allPosts = await getAllPosts();
const posts = await getPostsByTag(tag!);
const relatedTags = getRelatedTags(tag!, allPosts);
---

<Base title={`Posts tagged "${tag}"`}>
  <h1 class="page-title">Tagged: {tag}</h1>
  <p>{posts.length} post{posts.length === 1 ? '' : 's'}</p>

  <RelatedTags currentTag={tag!} relatedTags={relatedTags} />

  <div class="posts-list">
    {posts.map(post => <PostCard post={post} />)}
  </div>
</Base>
